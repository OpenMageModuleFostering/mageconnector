<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category   design_default
 * @package    Mage
 * @copyright  Copyright (c) 2008 Irubin Consulting Inc. DBA Varien (http://www.varien.com)
 * @license    http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/**
 * Product view template
 *
 * @see Mage_Catalog_Block_Product_View
 * @see Mage_Review_Block_Product_View
 */
?>
<?php
    $_helper = $this->helper('catalog/output');
    $_product = $this->getProduct();
	$_productDescriptionHelper = $this->helper('icecatimport/getdata')->getProductDescription($_product);
	$message = $_productDescriptionHelper->getError();
	if ($message){
		$this->getMessagesBlock()->addError($_productDescriptionHelper->getError());
	}
    $specificationArray = $_productDescriptionHelper->getProductDescriptionList();
	$relatedProductsList = $_productDescriptionHelper->getRelatedProducts();
?>
<script type="text/javascript">
    var optionsPrice = new Product.OptionsPrice(<?php echo $this->getJsonConfig() ?>);
</script>
<div id="messages_product_view"><?php echo $this->getMessagesBlock()->getGroupedHtml() ?></div>
<div style="display:none"><?php $message=$_productDescriptionHelper->hasSystemError(); if ($message){ echo $message; } ?></div>
<div class="product-info-box product-view">
    <div class="product-essential">
    <form action="<?php echo $this->getAddToCartUrl($_product) ?>" method="post" id="product_addtocart_form"<?php if($_product->getOptions()): ?> enctype="multipart/form-data"<?php endif; ?>>

        <div class="product-img-box">
            <?php echo $this->getChildHtml('media') ?>
        </div>

        <div class="product-shop">
            <?php if (!$_productDescriptionHelper->hasError()) : ?>
                <h3 class="product-name"><?php echo $_productDescriptionHelper->getProductName()?></h3>
            <?php else :?>
                <h1><?php echo $_helper->productAttribute($_product, $_product->getName(), 'name')?></h1>
            <?php endif;?>
            <?php if ($this->canEmailToFriend()): ?>
                <a href="<?php echo $this->helper('catalog/product')->getEmailToFriendUrl($_product) ?>"><?php echo $this->__('Email to a Friend') ?></a><br />
            <?php endif; ?>

            <?php echo $this->getReviewsSummaryHtml($_product, false, true)?>

            <fieldset class="no-display">
              <input type="hidden" name="product" value="<?php echo $_product->getId() ?>" />
              <input type="hidden" name="related_product" id="related-products-field" value="" />
            </fieldset>
            <?php  if (!$_productDescriptionHelper->hasError()):?>
            <div><b><?php echo $this->helper('icecatimport/getdata')->__('Brand:')?></b><?php echo $_productDescriptionHelper->getVendor();?></div>
            <div><b><?php echo $this->helper('icecatimport/getdata')->__('Product code:')?></b><?php echo $_productDescriptionHelper->getMPN();?></div>
            <div><b><?php echo $this->helper('icecatimport/getdata')->__('EAN/UPC code:')?></b><?php echo $_productDescriptionHelper->getEAN();?></div>
            <div><b><?php echo $this->helper('icecatimport/getdata')->__('Category:')?></b><?php echo $_product->getCategory()? $_product->getCategory()->getName() : ''?></div>
			<?php endif;?>
            <?php echo $this->getChildHtml('alert_urls') ?>
            <?php echo $this->getChildHtml('product_type_data') ?>
            <?php echo $this->getTierPriceHtml() ?>

            <?php if (!$this->hasOptions()):?>
                <div class="add-to-holder">
                    <?php if($_product->isSaleable()): ?>
                        <?php echo $this->getChildHtml('addtocart') ?>
                        <?php if( $this->helper('wishlist')->isAllow() || $_compareUrl=$this->helper('catalog/product_compare')->getAddUrl($_product)): ?>
                            <span class="add-or"><?php echo $this->__('OR') ?></span>
                        <?php endif; ?>
                    <?php endif; ?>
                    <?php echo $this->getChildHtml('addto') ?>
                </div>
            <?php else:?>
                <?php echo $this->getChildHtml('addto') ?>
            <?php endif; ?>
            
            <?php if ($_product->getShortDescription() && $_productDescriptionHelper->hasError()):?>
                <div class="short-description">
                    <h2><?php echo $this->__('Quick Overview') ?></h2>
                    <div class="std"><?php echo $_helper->productAttribute($_product, nl2br($_product->getShortDescription()), 'short_description') ?></div>
                </div>
            <?php else :?>
            	<div class="divider"></div>
            <?php endif;?>
            
              
            <?php echo $this->getChildHtml('other');?>
            <?php if ($_product->isSaleable() && $this->hasOptions()):?>
                <?php echo $this->getChildChildHtml('container1', '', true, true) ?>
            <?php endif;?>

        </div>
        <div class="clear"></div>
        <?php if ($_product->isSaleable() && $this->hasOptions()):?>
            <?php echo $this->getChildChildHtml('container2', '', true, true) ?>
        <?php endif;?>
    </form>
    <script type="text/javascript">
            var productAddToCartForm = new VarienForm('product_addtocart_form');
            productAddToCartForm.submit = function(){
                    if (this.validator.validate()) {
                            this.form.submit();
                    }
            }.bind(productAddToCartForm);

            function changeTab(id){
				for(var i=1;i<4;i++){
					var tab_cont = (document.getElementById) ? document.getElementById("tab_cont_"+i) : eval('document.all["tab_cont_'+i+'"]');
					var tab = (document.getElementById) ? document.getElementById("tab_"+i) : eval('document.all["tab_'+i+'"]');
					
					if (tab_cont!=null && tab!=null) {
						if(i==id){
							tab_cont.style.display="";
							tab.className="prod_doc_tab_div_sel";
						} else {
							tab_cont.style.display="none";
							tab.className="prod_doc_tab_div";
						}
					}
				}
			}
    </script>
    </div>
    <?php if (!$_productDescriptionHelper->hasError()) : ?>
	    <div class="description_b">
	    	<div class="short_product_description"><?php echo $_productDescriptionHelper->getShortProductDescription() ?></div>
	                  <?php 
	              	if (strlen($_productDescriptionHelper->getFullProductDescription())>450){
		              	$firstPart = str_replace("\\n", "<br>", substr($_productDescriptionHelper->getFullProductDescription(), 0, 400));
		              	$space = strrpos($firstPart, " ");
		              	$dot = strrpos($firstPart, ".");
		              	$column = strrpos($firstPart, ",");
		              	$spanTagStart = strrpos($firstPart, "<span");
		              	$spanTagEND = strrpos($firstPart, "</span>");
		              	
		              	if ($space-5>$dot && $space-5>$column){
		              		$firstPart = substr($firstPart, 0, $space);
		              	}
		              	else{
		              		$firstPart = $column > $dot ? substr($firstPart, 0, $column) : substr($firstPart, 0, $dot);
		              	}
		              	if ((int)$spanTagEND<$spanTagStart){
		              		$firstPart = substr($firstPart, 0, $spanTagStart);
		              	}
		              	
	              	}
	              
	              ?>
				<div class="product_description">
				 <?php if (isset($firstPart)):?>
				 	<span id="more_link"><?php echo $firstPart." "?>... <a class="more_link" href="javascript: showMore();"><?php echo htmlentities(' More>>>')?></a></span>
				 	<span id="more_info" style="display: none;"><?php echo str_replace("\\n", "<br>", $_productDescriptionHelper->getFullProductDescription());?><a class="more_link"  href="javascript: hideMore();"><?php echo htmlentities(' <<<Less')?></a></span>
				 <?php else: ?>
				 	<span><?php echo str_replace("\\n", "<br>", $_productDescriptionHelper->getFullProductDescription());?></span>
				 <?php endif?>
				 </div >
			</div>
		<?php endif;?>
    	<div class="product-collateral">
    	<?php if ($_productDescriptionHelper->hasError()) :?>
    		<?php echo $this->getChildHtml('description') ?>
    	<?php else :?>
	        <table cellspacing="0" cellpadding="0" width="100%">
				<tr>
					<td>
						<table cellspacing="0" cellpadding="0" class="prod_doc_tabs_row">
						<tr>
							<td class="prod_doc_tabs_space">&nbsp;</td>
							<td class="prod_doc_tab"><div id="tab_1" class="prod_doc_tab_div_sel" onclick="changeTab(1)"><?php echo $this->helper('icecatimport/getdata')->__('Specification') ?></div></td>
							<?php if ($_product->getCategoryId() && array_key_exists($_product->getCategoryId(), $relatedProductsList)):?>
								<td class="prod_doc_tab"><div id="tab_2" class="prod_doc_tab_div" onclick="changeTab(2)"><?php echo $this->helper('icecatimport/getdata')->__('Alternatives') ?></div></td>
							<?php endif?>
							<?php if (!empty($relatedProductsList)):?>
							<td class="prod_doc_tab"><div id="tab_3" class="prod_doc_tab_div" onclick="changeTab(3)"><?php echo $this->helper('icecatimport/getdata')->__('Options') ?></div></td>
							<?php endif?>
							<td class="prod_doc_tabs_space" style="width:auto!important">&nbsp;</td>
						</tr>
						</table>
					</td>
				</tr>
				<tr>
					<td>
						<table cellspacing="0" cellpadding="2" class="prod_doc_content">
						<tr>
							<td class="prod_doc_content_cell">
							<!-- FIRST TAB's CONTENT (VISIBLE BY DEFAULT) -->
								<table id="tab_cont_1" cellspacing="6" cellpadding="0" width="100%">
								<tr>
									<td width="50%" valign="top">
										<table cellspacing="0" cellpadding="2" class="prod_doc_table">
										        <?php foreach($specificationArray as $specBlock => $specArray):?>
											        <?php foreach ($specArray as $key=> $attributeArray):?>
											        <?php //$specArray = array_pop($specArray)?>
														<tr>
															<td colspan="3" class="prod_doc_block_head"><?php echo $key?></td>
														</tr>
															<?php foreach($attributeArray as $key => $value):?>
															<tr>
																<td colspan="2" class="prod_doc_item_head"><?php echo $key?></td>
																<td class="prod_doc_item_descr"><?php if($value == "Y"){
																	echo '<img border="0" alt="" src="http://prf.icecat.biz/imgs/yes.gif"/>';
																}
																else if ($value == "N"){
																	echo '<img border="0" alt="" src="http://prf.icecat.biz/imgs/no.gif"/>';
																}
																else{
																	echo str_replace("\\n", "<br>",$value);
																}
																?></td>
															</tr>
															<?php endforeach;?>
													<?php endforeach;?>
												<?php endforeach;?>
										</table>
									</td>
								</tr>
								</table>
								<!-- SECOND TAB's CONTENT (HIDDEN BY DEFAULT) -->
								<table id="tab_cont_2" cellspacing="6" cellpadding="0" width="100%" style="display:none">
								<tr>
									<td>
										<table cellspacing="1" cellpadding="5" class="prod_alt_table" width="100%" >
										<tr>
											<td class="prod_doc_block_head"><?php echo $this->helper('icecatimport/getdata')->__('Brand') ?></td>
											<td class="prod_doc_block_head"><?php echo $this->helper('icecatimport/getdata')->__('Image') ?></td>
											<td class="prod_doc_block_head"><?php echo $this->helper('icecatimport/getdata')->__('Article code') ?></td>
											<td class="prod_doc_block_head"><?php echo $this->helper('icecatimport/getdata')->__('Product name') ?></td>
										</tr>
										<?php if ($_product->getCategoryId() && array_key_exists($_product->getCategoryId(), $relatedProductsList)):?>
											<?php foreach($relatedProductsList[$_product->getCategoryId()] as $product):?>
												<tr>
													<td><img src="<?php echo $product['supplier_thumb']?>" /></td>
													<td><a href="<?php echo $product['url']?>"><img src="<?php echo $product['thumb']?>" /></a></td>
													<td><?php echo $product['mpn']?></td>
													<td><a href="<?php echo $product['url']?>" class="prod_link_small"><?php echo $product['name']?></a></td>
												</tr>
											<?php endforeach?>
										<?php else: ?>
												<tr><td></>No Alternative proposals for Current product avaible</td></tr>
										<?php endif?>
										</table>
									</td>
								</tr>
								</table>
								<!-- THIRD TAB's CONTENT (HIDDEN BY DEFAULT) -->
								<table id="tab_cont_3" cellspacing="6" cellpadding="0" width="100%" style="display:none">
								<tr>
									<td>
									
										<table cellspacing="1" cellpadding="5" width="100%"  class="prod_alt_table">
										<tr>
											<td class="prod_doc_block_head"><?php echo $this->helper('icecatimport/getdata')->__('Brand') ?></td>
											<td class="prod_doc_block_head"><?php echo $this->helper('icecatimport/getdata')->__('Image') ?></td>
											<td class="prod_doc_block_head"><?php echo $this->helper('icecatimport/getdata')->__('Article code') ?></td>
											<td class="prod_doc_block_head"><?php echo $this->helper('icecatimport/getdata')->__('Product name') ?></td>
										</tr>
										<?php if (!empty($relatedProductsList)):?>
											<?php foreach($relatedProductsList as $categoryId => $productsArray):?>
												<?php if ($categoryId == $_product->getCategoryId()){
													continue;
												}?>
											<?php if (!is_string($categoryId)):?>
												<tr>
													<td class="prod_doc_item_head2" colspan="4"><?php echo is_string($categoryId)? '' : Mage::getSingleton('catalog/category')->load($categoryId)->getName() ?></td>
													
												</tr>
											<?php endif?>
												<?php foreach($productsArray as $product):?>
													<tr>
														<td><img src="<?php echo $product['supplier_thumb']?>" /></td>
														<td><a href="<?php echo $product['url']?>"><img src="<?php echo $product['thumb']?>" /></a></td>
														<td><?php echo $product['mpn']?></td>
														<td><a href="<?php echo $product['url']?>" class="prod_link_small"><?php echo $product['name']?></a></td>
													</tr>
												<?php endforeach ?>
											<?php endforeach ?>
										<?php else: ?>
												<tr><td></>No Related proposals for Current product avaible</td></tr>
										<?php endif?>
										</table>
									</td>
								</tr>
								</table>
								<!-- EOF -->
							</td>
						</tr>
						</table>
					</td>
				</tr>
			</table>
		<?php endif;?>
        <?php if ($_additional = $this->getChildHtml('additional')):?>
            <div class="collateral-box">
                <div class="head">
                    <h4><?php echo $this->__('Additional Information') ?></h4>
                </div>
                <?php echo $_additional ?>
            </div>
        <?php endif;?>
        <?php echo $this->getChildHtml('upsell_products') ?>
        <?php echo $this->getChildHtml('product_additional_data') ?>
    </div>
</div>